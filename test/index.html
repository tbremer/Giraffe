<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<style>
		.display {
			font-family: monospace;
			white-space: pre;
		}
	</style>
</head>
<body>
	<section class="form">
		<fieldset>
			<legend>Add a Person</legend>
			<input type="text" name="person" placeholder="name" />
		</fieldset>

		<fieldset>
			<legend>Search for a Person</legend>
			<input type="text" name="search" placeholder="Search for a Person" />
		</fieldset>

		<fieldset class="js-link-people">
			<legend>Link two People</legend>
			<select name="person-a"></select>
			<input type="text" name="edge" placeholder="Connection" />
			<select name="person-b"></select>
			<button type="button" class="js-crete-edge">submit</button>
		</fieldset>

		<fieldset>
			<legend>Remove a Person</legend>
			<select multiple name="person"></select>
			<button type="button" class="js-remove-person">remove</button>
		</fieldset>

	</section>
	<section class="display"></section>

	<script src="../dist/bundle.js"></script>
	<script src="./vue.js"></script>
	<script>
		/* eslint-disable */
		const db = new Graff();
		const person = document.querySelector('input[name="person"]');
		const search = document.querySelector('input[name="search"]');
		const display = document.getElementsByClassName('display')[0];
		const allSelects = document.querySelectorAll('select');
		const createButton = document.querySelector('.js-crete-edge');
		const removeButton = document.querySelector('.js-remove-person');

		function removeOptions(nodes) {
			const ids = nodes.map(n => n._id);

			for (const i in ids) {
				const id = ids[i];

				allSelects.forEach(select => {
					const node = select.querySelector(`[data-id="${id}"]`);

					if (!node) return;
					select.removeChild(node);
				})
			}
		}

		function updateSelects() {
			// allSelects.innerHTML = '';
			const nodes = db.query('Person');
			const validIds = nodes.map(n => String(n._id));

			for (const i in nodes) {
				const node = nodes[i];
				const { _id: id, name } = node;

				allSelects.forEach(select => {
					const exists = select.querySelector(`[data-id="${id}"]`);
					if (exists) return;

					const option = document.createElement('option');
					option.innerText = option.value = name;
					option.setAttribute('data-id', id);

					select.appendChild(option);
				});
			}
		}

		function Person(name) {
			return db.create('Person', { name });
		}

		function actionOnEnter(e, cb) {
			e.preventDefault();
			const { keyCode } = e;

			if (keyCode !== 13) return;
			cb();
		}

		person.addEventListener('keyup', e => actionOnEnter(e, () => {
			const { target } = e;
			const { value: name } = target;

			e.target.value = '';
			new Person(name);

			updateSelects();
		}));

		search.addEventListener('keyup', e => actionOnEnter(e, () => {
			const results = db.query('Person', {name: e.target.value});
			e.target.value = '';

			display.innerHTML = JSON.stringify(results, null, 2);
		}));

		createButton.addEventListener('click', e => {
			const { target } = e;
			const people = [];
			const edgeLabel = target.parentNode.querySelector('input[name="edge"]').value;
			const selects = target.parentNode.querySelectorAll('select');

			selects.forEach(n => {
				const node = db.query('Person', { name: n.value });
				people.push(node);
			});

			const [a, b] = people;

			db.edge(a, b, edgeLabel);
		});

		removeButton.addEventListener('click', e => {
			const { target } = e;
			const people = [];
			const options = target.parentNode.querySelectorAll('select option')

			options.forEach(n => {
				if (!n.selected) return;
				const node = db.query('Person', { name: n.value });
				people.push(...node);
			});

			db.remove(people);
			console.log('allRemoved');
			removeOptions(people);
			console.log('allRemoved from ui');
		})
	</script>
</body>
</html>
